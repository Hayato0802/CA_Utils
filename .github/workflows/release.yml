name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.57)'
        required: true

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/v}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Update manifest version
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        jq --arg version "$VERSION" '.version = $version' manifest.json > manifest.tmp.json
        mv manifest.tmp.json manifest.json
        echo "Updated manifest.json to version $VERSION"
        cat manifest.json
    
    - name: Create ZIP for Chrome Web Store
      run: |
        zip -r co-assign-utils-${{ steps.version.outputs.VERSION }}.zip \
          manifest.json \
          background.js \
          content-script-coassign.js \
          content-script-hrmos.js \
          popup.html \
          popup.js \
          images/
    
    - name: Generate CRX file
      run: |
        # CRXç”Ÿæˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        chmod +x scripts/build.sh
        ./scripts/build.sh ${{ steps.version.outputs.VERSION }}
    
    - name: Generate release notes
      id: release_notes
      run: |
        echo "## ðŸš€ Co-Assign Utils v${{ steps.version.outputs.VERSION }}" > release_notes.md
        echo "" >> release_notes.md
        echo "### ðŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•" >> release_notes.md
        echo "" >> release_notes.md
        echo "#### æ–¹æ³•1: PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ï¼ˆæŽ¨å¥¨ï¼‰" >> release_notes.md
        echo '```powershell' >> release_notes.md
        echo '# çµ„ç¹”ã®ãƒªãƒã‚¸ãƒˆãƒªURLã«ç½®ãæ›ãˆã¦ãã ã•ã„' >> release_notes.md
        echo 'irm https://github.com/[organization]/[repository]/releases/latest/download/update.ps1 | iex' >> release_notes.md
        echo '```' >> release_notes.md
        echo "" >> release_notes.md
        echo "#### æ–¹æ³•2: æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«" >> release_notes.md
        echo "1. ä¸‹è¨˜ã® \`co-assign-utils-${{ steps.version.outputs.VERSION }}.zip\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> release_notes.md
        echo "2. Chromeã®æ‹¡å¼µæ©Ÿèƒ½ãƒšãƒ¼ã‚¸ï¼ˆchrome://extensions/ï¼‰ã‚’é–‹ã" >> release_notes.md
        echo "3. å³ä¸Šã®ã€Œãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã€ã‚’æœ‰åŠ¹åŒ–" >> release_notes.md
        echo "4. ã€Œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚Œã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’ã‚¯ãƒªãƒƒã‚¯" >> release_notes.md
        echo "5. è§£å‡ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠž" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ðŸ“ æ›´æ–°å±¥æ­´" >> release_notes.md
        echo "" >> release_notes.md
        # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        git log --pretty=format:"- %s" -n 5 >> release_notes.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Release v${{ steps.version.outputs.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          co-assign-utils-${{ steps.version.outputs.VERSION }}.zip
          co-assign-utils-${{ steps.version.outputs.VERSION }}.crx
          scripts/update.ps1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}